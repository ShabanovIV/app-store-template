{"version":3,"file":"643.7a8c8ca14cf2308ae857.js","mappings":"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","sources":["webpack://app-store/./src/shared/hooks/useMessage.ts","webpack://app-store/./src/shared/ui/RenderList/RenderList.module.scss?5ddc","webpack://app-store/./src/shared/ui/RenderList/RenderList.tsx","webpack://app-store/./src/features/ProductList/model/convertToItem.tsx","webpack://app-store/./src/features/ProductList/ui/ProductList.tsx","webpack://app-store/./src/features/ProductList/model/useProductPaginateData.ts","webpack://app-store/./src/features/ProductList/ui/ProductList.module.scss?e0d1","webpack://app-store/./src/pages/ProductPage/ProductPage.tsx","webpack://app-store/./src/shared/api/errors/useErrorHandler.ts","webpack://app-store/./src/shared/ui/RenderList/RenderListObserver.tsx"],"sourcesContent":["import { useContext } from 'react';\nimport { MessageContext } from 'src/shared/providers/MessageContext';\n\nexport const useMessage = () => {\n  const context = useContext(MessageContext);\n  if (!context) {\n    throw new Error('useMessage должен использоваться внутри <MessageProvider>');\n  }\n  return context;\n};\n","// extracted by mini-css-extract-plugin\nexport default {\"list\":\"RenderList-module_list-BF_R0\",\"listGrid\":\"RenderList-module_listGrid-VEEh9\",\"listItem\":\"RenderList-module_listItem-d2Xxn\",\"empty\":\"RenderList-module_empty-VeKxm\"};","import React, { forwardRef, memo } from 'react';\nimport { IRenderItem } from './IRenderItem';\nimport styles from './RenderList.module.scss';\n\nexport interface IRenderListProps {\n  isGrid?: boolean;\n  items: IRenderItem[];\n  lastItemRef?: React.RefObject<HTMLLIElement | null>;\n  onLastItemChanged?: (key: string) => void;\n}\n\nexport const RenderList: React.FC<IRenderListProps> = ({\n  isGrid,\n  items,\n  lastItemRef,\n  onLastItemChanged,\n}) => {\n  if (items.length === 0) {\n    return <div className={styles.empty}>No items to display</div>;\n  }\n\n  return (\n    <ul className={isGrid === undefined || isGrid ? styles.listGrid : styles.list}>\n      {items.map((item, index) => (\n        <ItemMemo\n          key={item.key}\n          item={item}\n          ref={setRefForLast({ items, index, lastItemRef, onLastItemChanged })}\n        />\n      ))}\n    </ul>\n  );\n};\n\ntype ListItemProps = {\n  item: IRenderItem;\n};\n\nconst ItemRef = forwardRef<HTMLLIElement, ListItemProps>(({ item }, ref) => (\n  <li id={item.key} ref={ref} className={styles.listItem}>\n    {item.render()}\n  </li>\n));\nItemRef.displayName = 'ItemRef';\n\nconst ItemMemo = memo(ItemRef);\n\nconst setRefForLast = ({\n  items,\n  index,\n  lastItemRef,\n  onLastItemChanged,\n}: {\n  items: IRenderItem[];\n  index: number;\n  onLastItemChanged?: (key: string) => void;\n  lastItemRef?: React.RefObject<HTMLLIElement | null>;\n}) => {\n  return (element: HTMLLIElement | null) => {\n    if (index === items.length - 1 && lastItemRef) {\n      lastItemRef.current = element;\n      if (onLastItemChanged) {\n        onLastItemChanged(items[items.length - 1].key);\n      }\n    }\n  };\n};\n","import { Product, ProductCard } from 'src/entities/Product';\nimport AddToCart from 'src/features/Cart/ui/AddToCart';\nimport { IRenderItem } from 'src/shared/ui/RenderList/IRenderItem';\n\nexport const convertToItem = (product: Product): IRenderItem => ({\n  key: product.id,\n  render: () => (\n    <ProductCard product={product} footer={() => <AddToCart productId={product.id} />} />\n  ),\n});\n","import { Divider, Space, Spin } from 'antd';\nimport RenderListObserver from 'src/shared/ui/RenderList/RenderListObserver';\nimport styles from './ProductList.module.scss';\nimport { useProductPaginateData } from '../model/useProductPaginateData';\n\ninterface ProductListProps {\n  categoryId: string;\n}\n\nexport const ProductList: React.FC<ProductListProps> = ({ categoryId }) => {\n  const { hasMore, isFetching, items, handleLastItem } = useProductPaginateData(categoryId);\n\n  return (\n    <div className={styles.container}>\n      <RenderListObserver items={items} onLastItem={handleLastItem} />\n      {(isFetching || !hasMore) && <Divider />}\n      {!hasMore && <Space className={styles.end}>Все продукты загружены</Space>}\n      {isFetching && <Spin />}\n    </div>\n  );\n};\n","import { useCallback, useEffect, useRef, useState } from 'react';\nimport { useGetProductsQuery } from 'src/entities/Product';\nimport { useAuth } from 'src/entities/User';\nimport { useErrorHandler } from 'src/shared/api/errors/useErrorHandler';\nimport { IRenderItem } from 'src/shared/ui/RenderList/IRenderItem';\nimport { convertToItem } from './convertToItem';\n\nconst PAGE_SIZE = 10;\n\nexport const useProductPaginateData = (categoryId: string) => {\n  const { isAuth } = useAuth();\n  const loadedPages = useRef<number[]>([]);\n  const [pageNumber, setPageNumber] = useState(1);\n  const [hasMore, setHasMore] = useState(true);\n  const [items, setItems] = useState<IRenderItem[]>([]);\n  const { data, isFetching, isLoading, error, refetch } = useGetProductsQuery(\n    {\n      categoryIds: [categoryId],\n      pagination: { pageSize: PAGE_SIZE, pageNumber: pageNumber },\n      sorting: { type: 'ASC', field: 'createdAt' },\n    },\n    {\n      refetchOnMountOrArgChange: true,\n    },\n  );\n  useErrorHandler({ error });\n\n  useEffect(() => {\n    if (data === undefined) {\n      loadedPages.current = [];\n      setItems([]);\n      setHasMore(true);\n      setPageNumber(1);\n    }\n  }, [data]);\n\n  useEffect(() => {\n    if (isLoading && isFetching) {\n      setItems([]);\n    }\n  }, [isFetching, isLoading]);\n\n  const handleLastItem = useCallback(() => {\n    if (!hasMore || isFetching) return;\n    setPageNumber((prev) => prev + 1);\n  }, [hasMore, isFetching]);\n\n  useEffect(() => {\n    if (\n      isAuth &&\n      data &&\n      data.data.length > 0 &&\n      !loadedPages.current.includes(pageNumber) &&\n      data.pagination.pageNumber === pageNumber\n    ) {\n      loadedPages.current.push(pageNumber);\n      setItems((prev) => [...prev, ...data.data.map((product) => convertToItem(product))]);\n    } else if (data && data.data.length < PAGE_SIZE) {\n      setHasMore(false);\n    }\n  }, [data, isAuth, pageNumber]);\n\n  return {\n    isFetching,\n    hasMore,\n    items,\n    refetch,\n    handleLastItem,\n  };\n};\n","// extracted by mini-css-extract-plugin\nexport default {\"container\":\"ProductList-module_container-N0fil\",\"end\":\"ProductList-module_end-mjnfC\"};","import { useParams } from 'react-router-dom';\nimport { ProductList } from 'src/features/ProductList';\n\nconst CategoryPage: React.FC = () => {\n  const { categoryId } = useParams<{ categoryId: string }>();\n  return <ProductList categoryId={categoryId!} />;\n};\n\nexport default CategoryPage;\n","import { useEffect } from 'react';\nimport { FormInstance } from 'antd';\nimport { useMessage } from 'src/shared/hooks/useMessage';\nimport { extractFormErrors, extractWithoutFiledErrors, throwIfGlobalError } from './errorParser';\n\nexport interface UseErrorHandlerProps<TFields> {\n  error: unknown;\n  form?: FormInstance<TFields>;\n}\n\nexport const useErrorHandler = <TFields>({ form, error }: UseErrorHandlerProps<TFields>) => {\n  const { showError } = useMessage();\n\n  useEffect(() => {\n    if (error) {\n      throwIfGlobalError(error);\n\n      if (form) {\n        form.setFields(extractFormErrors(error));\n      }\n\n      const joinedMessage = extractWithoutFiledErrors(error);\n      if (joinedMessage) {\n        showError(joinedMessage);\n      }\n    }\n  }, [error, form, showError]);\n};\n","import React, { useEffect, useRef, useCallback, useState } from 'react';\nimport { IRenderItem } from './IRenderItem';\nimport { RenderList } from './RenderList';\n\nexport interface IRenderListObserverProps {\n  items: IRenderItem[];\n  onLastItem: () => void;\n}\n\nconst RenderListObserver: React.FC<IRenderListObserverProps> = ({ items, onLastItem }) => {\n  const [lastItemKey, setLastItemKey] = useState('');\n  const prevLastItemKey = useRef('');\n  const lastItemRef = useRef<HTMLLIElement | null>(null);\n  const hasCalledOnLastItem = useRef(false);\n\n  const handleIntersection = useCallback(\n    (entries: IntersectionObserverEntry[]) => {\n      const entry = entries[0];\n      if (entry?.isIntersecting && !hasCalledOnLastItem.current) {\n        hasCalledOnLastItem.current = true;\n        onLastItem();\n      }\n    },\n    [onLastItem],\n  );\n\n  useEffect(() => {\n    if (lastItemKey === prevLastItemKey.current) {\n      return;\n    } else {\n      prevLastItemKey.current = lastItemKey;\n    }\n\n    const observer = new IntersectionObserver(handleIntersection, { threshold: 0.5 });\n\n    const currentLastItem = lastItemRef.current;\n    if (currentLastItem) {\n      observer.observe(currentLastItem);\n    }\n\n    return () => {\n      if (currentLastItem) {\n        observer.unobserve(currentLastItem);\n      }\n    };\n  }, [handleIntersection, lastItemKey]);\n\n  useEffect(() => {\n    hasCalledOnLastItem.current = false;\n  }, [lastItemKey]);\n\n  return <RenderList items={items} lastItemRef={lastItemRef} onLastItemChanged={setLastItemKey} />;\n};\n\nexport default RenderListObserver;\n"],"names":["useMessage","context","useContext","Error","RenderList","isGrid","items","lastItemRef","onLastItemChanged","length","className","undefined","map","item","index","ItemMemo","ref","setRefForLast","key","ItemRef","forwardRef","id","render","displayName","memo","element","current","ProductList","categoryId","hasMore","isFetching","handleLastItem","isAuth","loadedPages","useRef","pageNumber","setPageNumber","useState","setHasMore","setItems","data","isLoading","error","refetch","categoryIds","pagination","pageSize","sorting","type","field","refetchOnMountOrArgChange","useErrorHandler","u","useEffect","useCallback","prev","includes","push","product","Product","footer","AddToCart","A","productId","convertToItem","useProductPaginateData","RenderListObserver","onLastItem","form","showError","setFields","joinedMessage","lastItemKey","setLastItemKey","prevLastItemKey","hasCalledOnLastItem","handleIntersection","entries","entry","isIntersecting","observer","IntersectionObserver","threshold","currentLastItem","observe","unobserve"],"sourceRoot":""}